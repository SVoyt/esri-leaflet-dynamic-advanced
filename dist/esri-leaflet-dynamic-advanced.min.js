L.esri.DynamicMapLayerAdvanced=L.Layer.extend({options:{opacity:1,position:"front",useCors:L.esri.Support.cors,attribution:null,interactive:!1,alt:"",updateInterval:150,layers:!1,layerDefs:!1,timeOptions:!1,format:"png24",transparent:!0,f:"json"},initialize:function(t){t.url=L.esri.Util.cleanUrl(t.url),this.service=L.esri.mapService(t),this.service.addEventParent(this),(t.proxy||t.token)&&"json"!==t.f&&(t.f="json"),L.Util.setOptions(this,t),this._update=L.Util.throttle(this._update,this.options.updateInterval,this)},onAdd:function(t){t.on("moveend",this._update,this),this._singleImages&&0!==this._singleImages.length?this._forAllSingleImages(function(t){this._resetImagePosition(t),this.getPane(this.options.pane).appendChild(t)}):this._update(),this._popup&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this))},onRemove:function(){this._forAllSingleImages(function(t){this.options.interactive&&this.removeInteractiveTarget(t),this.getPane(this.options.pane).removeChild(t)}),this._popup&&(this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._map.off("moveend",this._update,this)},getEvents:function(){var t={zoom:this._reset,viewreset:this._reset};return this._zoomAnimated&&(t.zoomanim=this._animateZoom),t},_animateZoom:function(t){this._forAllSingleImages(function(i){var s=this._map.getZoomScale(t.zoom),e=this._map._latLngToNewLayerPoint(i.position.getNorthWest(),t.zoom,t.center);L.DomUtil.setTransform(i,e,s)})},_reset:function(){this._forAllSingleImages(function(t){this._resetImagePosition(t)})},getDynamicLayers:function(){return this.options.dynamicLayers},setDynamicLayers:function(t){return this.options.dynamicLayers=t,this._update(),this},getLayers:function(){return this.options.layers},setLayers:function(t){return this.options.layers=t,this._update(),this},getLayerDefs:function(){return this.options.layerDefs},setLayerDefs:function(t){return this.options.layerDefs=t,this._update(),this},getTimeOptions:function(){return this.options.timeOptions},setTimeOptions:function(t){return this.options.timeOptions=t,this._update(),this},query:function(){return this.service.query()},identify:function(){return this.service.identify()},find:function(){return this.service.find()},bringToFront:function(){return this.options.position="front",this._forAllSingleImages(function(t){L.DomUtil.toFront(t)}),this},bringToBack:function(){return this.options.position="back",this._forAllSingleImages(function(t){L.DomUtil.toBack(t)}),this},setZIndex:function(t){this.options.zIndex=t,this._forAllSingleImages(function(i){i.style.zIndex=t})},getAttribution:function(){return this.options.attribution},getOpacity:function(){return this.options.opacity},setOpacity:function(t){return this.options.opacity=t,this._forAllSingleImages(function(t){L.DomUtil.setOpacity(t,this.options.opacity)}),this},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(t,i){return this.options.from=t,this.options.to=i,this._update(),this},metadata:function(t,i){return this.service.metadata(t,i),this},authenticate:function(t){return this.service.authenticate(t),this},_getPopupData:function(t){var i=L.Util.bind(function(i,s,e){i||setTimeout(L.Util.bind(function(){this._renderPopup(t.latlng,i,s,e)},this),300)},this),s=this.identify().on(this._map).at(t.latlng);this.options.layers?s.layers("visible:"+this.options.layers.join(",")):s.layers("visible"),s.run(i),this._shouldRenderPopup=!0,this._lastClick=t.latlng},_renderPopup:function(t,i,s,e){if(t=L.latLng(t),this._shouldRenderPopup&&this._lastClick.equals(t)){var n=this._popupFunction(i,s,e);n&&this._popup.setLatLng(t).setContent(n).openOn(this._map)}},bindPopup:function(t,i){return this._shouldRenderPopup=!1,this._lastClick=!1,this._popup=L.popup(i),this._popupFunction=t,this._map&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this)),this},unbindPopup:function(){return this._map&&(this._map.closePopup(this._popup),this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._popup=!1,this},_resetPopupState:function(t){this._shouldRenderPopup=!1,this._lastClick=t.latlng},_initImage:function(){var t=L.DomUtil.create("img","leaflet-image-layer "+(this._zoomAnimated?"leaflet-zoom-animated":""));return t.onselectstart=L.Util.falseFn,t.onmousemove=L.Util.falseFn,this.options.zIndex&&(t.style.zIndex=this.options.zIndex),t.alt=this.options.alt,this.options.opacity<1&&L.DomUtil.setOpacity(t,this.options.opacity),this.options.useCors&&(t.crossOrigin=""),t},_imageLoaded:function(t){if(t.requestCount!==this._requestCounter.count)return void delete t.image;var i=this._resetImagePosition(t.image),s=[];if(this._forAllSingleImages(function(t){t.position.overlaps(i.position)&&s.push(t)}),this.getPane(this.options.pane).appendChild(i),this.options.interactive&&(L.DomUtil.addClass(i,"leaflet-interactive"),this.addInteractiveTarget(i)),this._singleImages.push(i),this._requestCounter.loadedImages++,this._requestCounter.allImages===this._requestCounter.loadedImages){var e=this._map.getBounds();this.fire("load",{bounds:e}),this._forAllSingleImages(function(t){t.position.overlaps(e)||s.push(t)})}for(var n=0;n<s.length;n++){this._removeImage(s[n]);var o=this._singleImages.indexOf(s[n]);-1!==o&&this._singleImages.splice(o,1)}},_resetImagePosition:function(t){var i=new L.Bounds(this._map.latLngToLayerPoint(t.position.getNorthWest()),this._map.latLngToLayerPoint(t.position.getSouthEast())),s=i.getSize();return L.DomUtil.setPosition(t,i.min),t.style.width=s.x+"px",t.style.height=s.y+"px",t},_incrementRequestCounter:function(t){this._requestCounter?this._requestCounter.count++:this._requestCounter={count:1},this._requestCounter.allImages=t,this._requestCounter.loadedImages=0},_update:function(){if(this._map){var t=this._map.getZoom();if(!this._animatingZoom&&!(this._map._panTransition&&this._map._panTransition._inProgress||t>this.options.maxZoom||t<this.options.minZoom)){var i=this._buildExportParams();this._requestExport(i)}}},_requestExport:function(t){this._singleImages||(this._singleImages=[]),this._incrementRequestCounter(t.length),this.fire("loading",{bounds:this._map.getBounds()});for(var i=0;i<t.length;i++){var s=t[i];s.requestCount=this._requestCounter.count,"json"===this.options.f?this.service.request("export",s.params,function(t,i){t||(this.param.href=i.href,this.context._renderImage(this.param))},{context:this,param:s}):(s.params.f="image",s.href=this.options.url+"export"+L.Util.getParamString(s.params),this._renderImage(s))}},_renderImage:function(t){var i=this._initImage();i.position=t.position,i.onload=L.bind(this._imageLoaded,this,{image:i,mapParams:t,requestCount:t.requestCount}),i.src=t.href},_buildExportParams:function(){var t=[],i=this._map.getBounds(),s=this._map.getSize(),e=i.getSouthWest(),n=i.getNorthEast(),o=e.lng,a=e.lng,r=0,h=(a+180)/360,p=Math.sign(h);p=0===p?1:p;for(var u=p*Math.floor(Math.abs(h));o<n.lng;){o=360*(u+r)+180*p,o>n.lng&&(o=n.lng);var l=a,m=o;if(-180>a|o>180){var c=Math.floor((a+180)/360);l-=360*c,m-=360*c}var g=L.latLngBounds(L.latLng(e.lat,l),L.latLng(n.lat,m)),_=L.latLngBounds(L.latLng(e.lat,a),L.latLng(n.lat,o)),f=s.x*((o-a)/(n.lng-e.lng)),d={x:f,y:s.y},y=this._buildSingleExportParams(g,d);t.push({position:_,bounds:g,size:d,params:y}),a=o,r++}return t},_buildSingleExportParams:function(t,i){var s=this._map.options.crs.project(t.getNorthEast()),e=this._map.options.crs.project(t.getSouthWest()),n=parseInt(this._map.options.crs.code.split(":")[1],10),o=this._map.latLngToLayerPoint(t._northEast),a=this._map.latLngToLayerPoint(t._southWest);(o.y>0||a.y<i.y)&&(i.y=a.y-o.y);var r={bbox:[e.x,e.y,s.x,s.y].join(","),size:i.x+","+i.y,dpi:96,format:this.options.format,transparent:this.options.transparent,bboxSR:n,imageSR:n};return this.options.dynamicLayers&&(r.dynamicLayers=this.options.dynamicLayers),this.options.layers&&(r.layers="show:"+this.options.layers.join(",")),this.options.layerDefs&&(r.layerDefs=JSON.stringify(this.options.layerDefs)),this.options.timeOptions&&(r.timeOptions=JSON.stringify(this.options.timeOptions)),this.options.from&&this.options.to&&(r.time=this.options.from.valueOf()+","+this.options.to.valueOf()),this.service.options.token&&(r.token=this.service.options.token),r},_removeImage:function(t){this.getPane(this.options.pane).removeChild(t),this.options.interactive&&this.removeInteractiveTarget(t)},_forAllSingleImages:function(t){if(this._singleImages)for(var i=0;i<this._singleImages.length;i++)t.call(this,this._singleImages[i])}}),L.esri.dynamicMapLayerAdvanced=function(t){return new L.esri.DynamicMapLayerAdvanced(t)};